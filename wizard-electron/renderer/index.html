<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
  <title>GRES B2B Setup</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="wizard">
    <header class="wizard-header">
      <h1>GRES B2B Governance</h1>
      <p class="subtitle">Setup Wizard</p>
    </header>

    <div class="wizard-content">
      <!-- Preflight Step (S1) -->
      <section id="step-preflight" class="step active">
        <div class="step-icon">
          <div class="spinner"></div>
        </div>
        <h2><span class="section-badge">S1</span> Preflight</h2>
        <p>Checking system requirements...</p>
        <div id="preflightStatus" class="preflight-status">
          <div class="note">Verifying permissions and directories...</div>
        </div>
        <div id="preflightDetail" class="preflight-detail"></div>
        <div class="step-actions">
          <button class="btn btn-primary" id="btnPreflightRetry" onclick="wizard.retryPreflight()" style="display: none;">Retry</button>
        </div>
      </section>

      <!-- Step 1: Welcome -->
      <section id="step-welcome" class="step">
        <div class="step-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
        </div>
        <h2>Welcome</h2>
        <p>Set up GRES B2B Governance for your AI agent</p>
        <div class="checklist">
          <div class="check-item"><span class="check-icon">&#10003;</span><span>Auto-detect AI agents</span></div>
          <div class="check-item"><span class="check-icon">&#10003;</span><span>Download & verify binary</span></div>
          <div class="check-item"><span class="check-icon">&#10003;</span><span>Configure MCP connection</span></div>
          <div class="check-item"><span class="check-icon">&#10003;</span><span>Verify handshake</span></div>
        </div>
        <p class="note">No admin rights required</p>
        <div class="step-actions">
          <button class="btn btn-primary" onclick="wizard.start()">Get Started</button>
        </div>
      </section>

      <!-- Step 2: Detect Agents (S2) -->
      <section id="step-detect" class="step">
        <h2><span class="section-badge" id="detectSectionBadge">S2</span> Detecting AI Agents</h2>
        <p>Scanning for config files...</p>
        <div id="agentList" class="agent-list"></div>
        <div id="detectStatus" class="note"></div>
        <div class="step-actions">
          <button class="btn btn-secondary" onclick="wizard.back()">Back</button>
          <button class="btn btn-primary" id="btnSyncAll" onclick="wizard.syncAll()" style="display: none;">Sync All</button>
          <button class="btn btn-primary" id="btnDetectNext" onclick="wizard.selectAgents()" disabled>Configure Selected</button>
        </div>
      </section>

      <!-- Step 3: Install (WZ-003, S3, WZ-005) -->
      <section id="step-install" class="step">
        <h2><span class="section-badge" id="installSectionBadge">S3</span> Configuring Environment</h2>
        <p>Setting up the GRES B2B bridge...</p>
        <div class="progress-steps" id="installSteps">
          <div class="progress-step" id="step-checksum">
            <div class="step-status"></div>
            <div class="step-content">
              <div class="step-title">Installing Binary</div>
              <div class="step-detail" id="detail-checksum">Waiting...</div>
            </div>
          </div>
          <div class="progress-step" id="step-path">
            <div class="step-status"></div>
            <div class="step-content">
              <div class="step-title">Configuring PATH</div>
              <div class="step-detail" id="detail-path">Waiting...</div>
            </div>
          </div>
          <div class="progress-step" id="step-config">
            <div class="step-status"></div>
            <div class="step-content">
              <div class="step-title">Writing Agent Config</div>
              <div class="step-detail" id="detail-config">Waiting...</div>
            </div>
          </div>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar"><div class="progress-fill" id="installProgress"></div></div>
          <div class="progress-label">
            <span id="installStatus">Preparing...</span>
            <span id="installPercent">0%</span>
          </div>
        </div>
      </section>

      <!-- Step 4: Zombie Guard (S4) -->
      <section id="step-zombie" class="step">
        <h2><span class="section-badge" id="zombieSectionBadge">S4</span> Restart Required</h2>
        <p>Please close your AI agent to apply changes</p>
        <div class="zombie-alert">
          <h3 id="zombieAgent">Waiting for Agent</h3>
          <p>Close <strong id="zombieProcess">Agent</strong> completely</p>
          <p class="note" id="zombieRestart">Please close and reopen the application.</p>
          <div class="spinner"></div>
          <p class="note" id="zombieStatus">Checking...</p>
        </div>
        <div class="step-actions mt-4">
          <button class="btn btn-danger" id="btnForceKill" onclick="wizard.forceKill()">Force Close</button>
          <button class="btn btn-secondary" id="btnSkipZombie" onclick="wizard.skipZombie()" style="display: none;">Continue Anyway</button>
        </div>
      </section>

      <!-- Step 5: Verify (S5) -->
      <section id="step-verify" class="step">
        <h2><span class="section-badge" id="verifySectionBadge">S5</span> Verification</h2>
        <p>Running self-tests...</p>
        <div class="progress-steps" id="verifySteps">
          <div class="progress-step" id="verify-binary">
            <div class="step-status"></div>
            <div class="step-content">
              <div class="step-title">Binary Test</div>
              <div class="step-detail" id="verify-binary-detail">Waiting...</div>
            </div>
          </div>
          <div class="progress-step" id="verify-path">
            <div class="step-status"></div>
            <div class="step-content">
              <div class="step-title">PATH Test</div>
              <div class="step-detail" id="verify-path-detail">Waiting...</div>
            </div>
          </div>
          <div class="progress-step" id="verify-mcp">
            <div class="step-status"></div>
            <div class="step-content">
              <div class="step-title">MCP Handshake</div>
              <div class="step-detail" id="verify-mcp-detail">Waiting...</div>
            </div>
          </div>
        </div>
        <div id="verifyResult"></div>
      </section>

      <!-- Step 6: Project Mode -->
      <section id="step-mode" class="step">
        <h2><span class="section-badge">S6</span> Project Mode</h2>
        <p>Choose how GRES should treat your codebase.</p>
        <div class="mode-card">
          <label class="mode-option">
            <input type="radio" name="projectMode" value="greenfield" />
            <div class="mode-body">
              <div class="mode-title">Greenfield (Builder)</div>
              <div class="mode-desc">Initialize structure only, no scan.</div>
            </div>
          </label>
          <label class="mode-option">
            <input type="radio" name="projectMode" value="brownfield" />
            <div class="mode-body">
              <div class="mode-title">Brownfield (Transformer)</div>
              <div class="mode-desc">Scan existing code, generate report, enable repair loop.</div>
            </div>
          </label>
        </div>
        <div id="modeStatus" class="note"></div>
        <div class="step-actions">
          <button class="btn btn-secondary" onclick="wizard.back()">Back</button>
          <button class="btn btn-primary" id="btnModeNext" onclick="wizard.confirmMode()" disabled>Next</button>
        </div>
      </section>

      <!-- Step 7: Target Selection -->
      <section id="step-target" class="step">
        <h2><span class="section-badge">S7</span> Select Project</h2>
        <p>Choose a local folder or GitHub repo to scan.</p>
        <div class="card">
          <h3>Target</h3>
          <div class="field-row">
            <label>Local Path</label>
            <input id="targetPath" type="text" placeholder="C:\repo" />
          </div>
          <div class="field-row">
            <label>Git Repo URL</label>
            <input id="repoUrl" type="text" placeholder="https://github.com/org/repo.git" />
          </div>
          <div class="field-row">
            <label>Ref</label>
            <input id="repoRef" type="text" placeholder="main" />
          </div>
          <div class="field-row">
            <label>Subdir</label>
            <input id="repoSubdir" type="text" placeholder="" />
          </div>
          <div class="step-actions">
            <button class="btn btn-secondary" onclick="wizard.setTarget()">Set Target</button>
            <button class="btn btn-secondary" onclick="wizard.selfCheckSetup()">Self-check</button>
          </div>
          <div id="targetStatus" class="note">
            <span id="setupCheckBadge" class="section-badge success" style="display: none; margin-right: 6px;">SAVED</span>
          </div>
        </div>
        <div class="step-actions">
          <button class="btn btn-secondary" onclick="wizard.back()">Back</button>
          <button class="btn btn-primary" id="btnTargetNext" onclick="wizard.confirmTarget()" disabled>Next</button>
        </div>
      </section>

      <!-- Step 8: Scan & Fix Loop -->
      <section id="step-scanfix" class="step">
        <h2><span class="section-badge" id="scanfixSectionBadge">S8</span> Scan & Fix Loop</h2>
        <p>Run scan, generate fixes, and rescan until green.</p>

        <div class="card">
          <h3>Report Status</h3>
          <div class="status-grid">
            <div class="status-item"><div class="status-label">Phase1</div><div class="status-value" id="phase1Status">-</div></div>
            <div class="status-item"><div class="status-label">Phase2</div><div class="status-value" id="phase2Status">-</div></div>
            <div class="status-item"><div class="status-label">Phase3</div><div class="status-value" id="phase3Status">-</div></div>
            <div class="status-item"><div class="status-label">Phase4</div><div class="status-value" id="phase4Status">-</div></div>
          </div>
          <div class="status-grid">
            <div class="status-item"><div class="status-label">RED</div><div class="status-value" id="redCount">-</div></div>
            <div class="status-item"><div class="status-label">AMBER</div><div class="status-value" id="amberCount">-</div></div>
            <div class="status-item"><div class="status-label">GREEN</div><div class="status-value" id="greenCount">-</div></div>
          </div>
          <div id="scanFindings" class="note"></div>
          <div id="topRules" class="note"></div>
        </div>

        <div class="checklist">
          <div class="check-item"><span class="check-icon">?</span><span>Scan -> Report (.b2b/report.json)</span></div>
          <div class="check-item"><span class="check-icon">?</span><span>Fix Plan (.b2b/fix-plan.json, .b2b/fix.patch)</span></div>
          <div class="check-item"><span class="check-icon">?</span><span>Rescan and refresh HUD</span></div>
        </div>
        <div class="step-actions">
          <button class="btn btn-secondary" onclick="wizard.back()">Back</button>
          <button class="btn btn-primary" onclick="wizard.runScan()">Run Scan</button>
          <button class="btn btn-primary" onclick="wizard.runFixLoop()">Run Fix Loop</button>
          <button class="btn btn-secondary" onclick="wizard.runRescan()">Rescan</button>
          <button class="btn btn-secondary" onclick="wizard.openHUD()">Open HUD</button>
          <button class="btn btn-primary" onclick="wizard.next()">Continue</button>
        </div>
      </section>

<!-- Step 6: Success -->
      <section id="step-success" class="step">
        <div class="success-ring">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <h2><span class="section-badge">S8</span> Final Verification</h2>
        <p>Your environment is configured and verified</p>
        <div class="status-grid">
          <div class="status-item">
            <div class="status-label">MCP Bridge</div>
            <div class="status-value"><span class="status-badge active">Verified</span></div>
          </div>
          <div class="status-item">
            <div class="status-label">Agent</div>
            <div class="status-value" id="successAgent">-</div>
          </div>
          <div class="status-item">
            <div class="status-label">Version</div>
            <div class="status-value" id="successVersion">-</div>
          </div>
          <div class="status-item">
            <div class="status-label">Config</div>
            <div class="status-value" id="successConfig">-</div>
          </div>
        </div>
        <div id="successNote"></div>
        <p class="note">HUD shortcut will be created</p>
        <div class="step-actions">
          <button class="btn btn-secondary" onclick="wizard.openDocs()">Documentation</button>
          <button class="btn btn-primary" onclick="wizard.launchDashboard()">Launch Dashboard</button>
        </div>
      </section>

      <!-- Error State -->
      <section id="step-error" class="step">
        <div class="step-icon error">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
        </div>
        <h2>Setup Failed</h2>
        <div class="error-box">
          <div class="error-title" id="errorTitle">Error</div>
          <div class="error-message" id="errorMessage"></div>
          <div class="error-details" id="errorDetails"></div>
        </div>
        <div class="step-actions">
          <button class="btn btn-secondary" onclick="wizard.retry()">Try Again</button>
          <button class="btn btn-primary" onclick="wizard.openDocs()">Get Help</button>
        </div>
      </section>
    </div>

    <footer class="wizard-footer">
      <span>GRES B2B Governance</span>
      <span id="wizardVersion">v1.0.0</span>
    </footer>
  </div>

  <script src="wizard.js"></script>
</body>
</html>
