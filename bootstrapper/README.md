# GRES B2B Bootstrapper

Zero-terminal Windows installer using native dialogs. No PowerShell or admin required.

## State Machine Flow

```
Step 1: Welcome (Permission Gate)
    ↓
Step 2: Agent Select (Input Gate)
    ↓
Step 3: Project Location (Input Gate)
    ↓
Step 4: Automation Install (Silent)
    ↓
Step 5: Verification (Gatekeeper)
    ↓
Success → Open Onboarding Dashboard
```

## Key Design Decisions

| Requirement | Implementation |
|-------------|----------------|
| Agent-agnostic MCP verification | `gres-b2b mcp selftest` (protocol-level) |
| Single EXE | No external Node/Python dependencies |
| Per-user install | `%LOCALAPPDATA%\Programs\gres-b2b` |
| Config persistence | `%LOCALAPPDATA%\gres-b2b\config.toml` |
| Idempotent PATH update | HKCU\Environment registry |
| Environment refresh | WM_SETTINGCHANGE broadcast |
| No terminal required | Uses dlgs native dialogs |

## Step Details

### Step 1: Welcome (Permission Gate)
- Question dialog: "Continue?"
- Cancel exits cleanly

### Step 2: Agent Select (Input Gate)
- List dialog with options:
  - Claude Desktop
  - Cursor
  - VS Code (Windsurf)
  - Codex CLI
  - Custom MCP
- Must select one to proceed

### Step 3: Project Location (Input Gate)
- Native folder picker
- Validates folder exists and is readable

### Step 4: Automation Install (Silent)
- Creates `%LOCALAPPDATA%\Programs\gres-b2b\`
- Downloads latest `gres-b2b.exe` from GitHub Releases
- Updates User PATH (HKCU\Environment) idempotently
- Broadcasts WM_SETTINGCHANGE
- Creates `%LOCALAPPDATA%\gres-b2b\config.toml`

### Step 5: Verification (Gatekeeper)
Both must pass to proceed:
1. **MCP selftest**: `gres-b2b mcp selftest`
   - Protocol-level handshake verification
   - If fails → "Connection Refused" and stop
2. **Doctor**: `gres-b2b --config <path> doctor`
   - Must exit 0
   - If fails → show error and stop

Only on success: opens `onboarding?status=ready`

## Build

### Prerequisites
- Go 1.22+
- Windows (uses Windows-specific APIs)

### Build Steps

```batch
cd bootstrapper
build.bat
```

Output: `gres-b2b-setup.exe` (GUI application, no console window)

### Manual Build

```batch
go mod download
go build -ldflags="-H windowsgui -s -w" -o gres-b2b-setup.exe .
```

## File Locations

| File | Location |
|------|----------|
| Binary | `%LOCALAPPDATA%\Programs\gres-b2b\gres-b2b.exe` |
| Config | `%LOCALAPPDATA%\gres-b2b\config.toml` |

## Config Schema (TOML)

```toml
# GRES B2B Governance Configuration
# Generated by installer

[agent]
name = "Claude Desktop"
mcp_enabled = true

[project]
root = "C:/Users/.../my-project"

[governance]
auto_scan = true

[install]
version = "1.0.0"
binary_path = "C:/Users/.../Programs/gres-b2b/gres-b2b.exe"
```

## Critical Implementation Notes

### Do NOT use `setx PATH`
It can truncate PATH and is not idempotent-safe. Use HKCU registry + WM_SETTINGCHANGE.

### MCP verification must be protocol-level
An HTTP ping is not agent-agnostic and often wrong. Use `gres-b2b mcp selftest`.

### "Done" state requirements
Only open success page if BOTH pass:
- MCP selftest exits 0
- Doctor exits 0

## Dependencies

- [gen2brain/dlgs](https://github.com/gen2brain/dlgs) - Native Windows dialogs
- [golang.org/x/sys/windows](https://pkg.go.dev/golang.org/x/sys/windows) - Windows API
- [golang.org/x/sys/windows/registry](https://pkg.go.dev/golang.org/x/sys/windows/registry) - Registry access

## Definition of Done

- [x] Single-file deliverable (`gres-b2b-setup.exe`)
- [x] Runs asInvoker (no elevation)
- [x] No external dependencies (Node/Python)
- [x] Agent selection step
- [x] Folder picker with validation
- [x] GitHub Releases download
- [x] Idempotent PATH update via registry
- [x] WM_SETTINGCHANGE broadcast
- [x] TOML config generation
- [x] MCP selftest verification (gatekeeper)
- [x] Doctor verification (gatekeeper)
- [x] Opens success page only on full verification
