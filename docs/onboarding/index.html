<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GRES B2B Governance - Setup Wizard</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      min-height: 100vh;
      padding: 2rem;
    }

    .wizard-container {
      max-width: 960px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }

    .wizard-header {
      background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }

    .wizard-header h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .wizard-header p { color: rgba(255,255,255,0.8); font-size: 0.95rem; }

    .badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 1rem;
      backdrop-filter: blur(10px);
    }

    .wizard-content { padding: 2rem; }

    .step { display: none; animation: fadeIn 0.3s ease; }
    .step.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gray-500);
      transition: all 0.3s;
    }

    .step-dot.active { background: var(--primary); color: white; transform: scale(1.1); }
    .step-dot.completed { background: var(--success); color: white; }

    h2 { font-size: 1.5rem; color: var(--gray-900); margin-bottom: 0.5rem; }
    h3 { font-size: 1.1rem; color: var(--gray-700); margin-bottom: 0.75rem; }
    p { color: var(--gray-600); line-height: 1.6; margin-bottom: 1rem; }
    code { background: var(--gray-100); padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.9em; }

    .input-group { margin: 1.5rem 0; }
    .input-group label { display: block; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem; }
    .input-group input, .input-group select, .input-group textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--primary); }
    .input-group .hint { font-size: 0.85rem; color: var(--gray-500); margin-top: 0.5rem; }

    .input-row { display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: end; }

    .mode-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .mode-card {
      background: var(--gray-50);
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .mode-card:hover { border-color: var(--primary); background: #eff6ff; }
    .mode-card.selected { border-color: var(--primary); background: #eff6ff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
    .mode-card .icon { font-size: 2rem; margin-bottom: 0.75rem; }
    .mode-card .name { font-weight: 600; color: var(--gray-800); margin-bottom: 0.25rem; }
    .mode-card .desc { font-size: 0.85rem; color: var(--gray-500); }
    .mode-card .recommended { background: var(--success); color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-top: 0.5rem; display: inline-block; }

    .terminal {
      background: #0d1117;
      border-radius: 12px;
      overflow: hidden;
      margin: 1.5rem 0;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      border: 1px solid #30363d;
    }

    .terminal-header {
      background: #161b22;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 1px solid #30363d;
    }

    .terminal-dot { width: 12px; height: 12px; border-radius: 50%; }
    .terminal-dot.red { background: #ff5f56; }
    .terminal-dot.yellow { background: #ffbd2e; }
    .terminal-dot.green { background: #27ca40; }

    .terminal-title { color: #8b949e; font-size: 0.8rem; margin-left: auto; }

    .terminal-body { padding: 1rem; max-height: 400px; overflow-y: auto; }

    .terminal-line { color: #c9d1d9; font-size: 0.85rem; line-height: 1.6; margin-bottom: 0.25rem; white-space: pre-wrap; }
    .terminal-line.comment { color: #8b949e; }
    .terminal-line.command { color: #58a6ff; }
    .terminal-line.success { color: #3fb950; }
    .terminal-line.error { color: #f85149; }
    .terminal-line.output { color: #8b949e; }

    .terminal-actions { padding: 0.75rem 1rem; background: #161b22; border-top: 1px solid #30363d; display: flex; gap: 0.5rem; }
    .terminal-btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; font-weight: 500; }
    .terminal-btn.primary { background: var(--primary); color: white; }
    .terminal-btn.primary:hover { background: var(--primary-dark); }
    .terminal-btn.secondary { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }

    .btn {
      padding: 0.875rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 1rem;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:disabled { background: var(--gray-300); cursor: not-allowed; }
    .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
    .btn-secondary:hover { background: var(--gray-200); }
    .btn-success { background: var(--success); color: white; }
    .btn-lg { padding: 1rem 2rem; font-size: 1.1rem; }

    .button-group { display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end; flex-wrap: wrap; }

    .status-box {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      border-radius: 12px;
      margin: 1rem 0;
      align-items: flex-start;
    }

    .status-box.success { background: #f0fdf4; border: 1px solid #86efac; }
    .status-box.warning { background: #fffbeb; border: 1px solid #fcd34d; }
    .status-box.danger { background: #fef2f2; border: 1px solid #fecaca; }
    .status-box.info { background: #eff6ff; border: 1px solid #93c5fd; }

    .status-icon { font-size: 1.5rem; flex-shrink: 0; }
    .status-content { flex: 1; }
    .status-content strong { display: block; margin-bottom: 0.25rem; color: var(--gray-800); }
    .status-content p { margin: 0; font-size: 0.9rem; }

    .verification-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .verify-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 8px;
      border: 2px solid var(--gray-200);
      transition: all 0.3s;
    }

    .verify-item.pass { background: #f0fdf4; border-color: var(--success); }
    .verify-item.fail { background: #fef2f2; border-color: var(--danger); }
    .verify-item.running { border-color: var(--primary); }

    .verify-icon { font-size: 1.5rem; }
    .verify-info { flex: 1; }
    .verify-name { font-weight: 600; font-size: 0.9rem; color: var(--gray-800); }
    .verify-status { font-size: 0.8rem; color: var(--gray-500); }

    .config-preview {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 0.85rem;
      color: #d4d4d4;
      overflow-x: auto;
    }

    .config-preview .key { color: #9cdcfe; }
    .config-preview .string { color: #ce9178; }
    .config-preview .section { color: #4ec9b0; }

    .tabs { display: flex; gap: 0; border-bottom: 2px solid var(--gray-200); margin-bottom: 1.5rem; }
    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      color: var(--gray-500);
      font-weight: 500;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab:hover { color: var(--gray-700); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .iteration-timeline {
      position: relative;
      padding-left: 2rem;
      margin: 1.5rem 0;
    }

    .iteration-timeline::before {
      content: '';
      position: absolute;
      left: 0.5rem;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--gray-200);
    }

    .iteration-item {
      position: relative;
      padding: 1rem;
      margin-bottom: 1rem;
      background: var(--gray-50);
      border-radius: 8px;
      border-left: 3px solid var(--gray-300);
    }

    .iteration-item::before {
      content: '';
      position: absolute;
      left: -1.75rem;
      top: 1.25rem;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--gray-300);
    }

    .iteration-item.pass { border-left-color: var(--success); }
    .iteration-item.pass::before { background: var(--success); }
    .iteration-item.fail { border-left-color: var(--danger); }
    .iteration-item.fail::before { background: var(--danger); }
    .iteration-item.running { border-left-color: var(--primary); }
    .iteration-item.running::before { background: var(--primary); animation: pulse 1s infinite; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .iteration-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .iteration-title { font-weight: 600; color: var(--gray-800); }
    .iteration-counts { display: flex; gap: 0.5rem; font-size: 0.85rem; }
    .count-red { color: var(--danger); font-weight: 600; }
    .count-amber { color: var(--warning); font-weight: 600; }
    .count-green { color: var(--success); font-weight: 600; }

    .collapsible { cursor: pointer; }
    .collapsible-content { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200); }
    .collapsible-content.show { display: block; }

    .copy-feedback {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gray-900);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    .copy-feedback.show { opacity: 1; }

    .detected-badge {
      display: inline-block;
      background: var(--success);
      color: white;
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
    }

    @media (max-width: 768px) {
      body { padding: 1rem; }
      .wizard-content { padding: 1.5rem; }
      .button-group { flex-direction: column; }
      .btn { width: 100%; }
      .mode-cards { grid-template-columns: 1fr; }
      .verification-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wizard-container">
    <div class="wizard-header">
      <span class="badge">Agent-Agnostic Setup</span>
      <h1>GRES B2B Governance</h1>
      <p>Universal MCP Setup + Verified Connectivity + Live Scans</p>
    </div>

    <div class="wizard-content">
      <div class="step-indicator" id="step-indicator"></div>

      <!-- Step 1: Agent Mode Selection -->
      <div class="step active" data-step="1">
        <h2>Step 1: Choose Setup Mode</h2>
        <p>How would you like to configure MCP connectivity with your AI agent?</p>

        <div class="mode-cards">
          <div class="mode-card" data-mode="auto" onclick="selectMode('auto')">
            <div class="icon">üîç</div>
            <div class="name">Auto-Detect</div>
            <div class="desc">We'll scan for known AI agents and configure automatically</div>
            <div class="recommended">Recommended</div>
          </div>
          <div class="mode-card" data-mode="manual" onclick="selectMode('manual')">
            <div class="icon">üìÅ</div>
            <div class="name">Paste Config Path</div>
            <div class="desc">I'll provide my agent's config file or folder path</div>
          </div>
          <div class="mode-card" data-mode="skip" onclick="selectMode('skip')">
            <div class="icon">‚è≠Ô∏è</div>
            <div class="name">Skip Agent Setup</div>
            <div class="desc">I'll configure my agent later; just verify the server</div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-primary btn-lg" onclick="nextStep()" id="step1-next" disabled>Continue</button>
        </div>
      </div>

      <!-- Step 2: Config Detection / Path Input -->
      <div class="step" data-step="2">
        <h2>Step 2: Configure MCP Server</h2>
        <div id="config-step-content"></div>
      </div>

      <!-- Step 3: Verify MCP Connection (Universal) -->
      <div class="step" data-step="3">
        <h2>Step 3: Verify MCP Connection</h2>
        <p>We'll prove the MCP server works independently of your AI agent.</p>

        <div class="status-box info">
          <div class="status-icon">üí°</div>
          <div class="status-content">
            <strong>Agent-Agnostic Verification</strong>
            <p>This test uses protocol-level verification (JSON-RPC handshake), not an HTTP ping. It works with stdio-based and HTTP-based MCP servers alike.</p>
          </div>
        </div>

        <h3>Run Self-Test</h3>
        <div class="terminal">
          <div class="terminal-header">
            <span class="terminal-dot red"></span>
            <span class="terminal-dot yellow"></span>
            <span class="terminal-dot green"></span>
            <span class="terminal-title">MCP Self-Test</span>
          </div>
          <div class="terminal-body">
            <div class="terminal-line comment"># Verify MCP server is healthy (agent-agnostic, protocol-level)</div>
            <div class="terminal-line command">gres-b2b mcp selftest</div>
          </div>
          <div class="terminal-actions">
            <button class="terminal-btn primary" onclick="copyCommand('gres-b2b mcp selftest')">Copy Command</button>
            <button class="terminal-btn secondary" onclick="runSelftestDemo()">Run Demo</button>
          </div>
        </div>

        <h4 style="margin-top: 1rem;">Expected Output</h4>
        <div class="terminal" style="margin-top: 0.5rem;">
          <div class="terminal-body">
            <div class="terminal-line success">MCP_STATUS: READY (tools=12, handshake=ok)</div>
          </div>
        </div>
        <p style="font-size: 0.9rem; color: var(--gray-500); margin-top: 0.5rem;">If MCP fails, you'll see: <code>MCP_STATUS: FAILED (reason)</code></p>

        <div class="verification-grid" id="selftest-results">
          <div class="verify-item" id="verify-server">
            <div class="verify-icon">‚è≥</div>
            <div class="verify-info">
              <div class="verify-name">Server Starts</div>
              <div class="verify-status">Waiting...</div>
            </div>
          </div>
          <div class="verify-item" id="verify-handshake">
            <div class="verify-icon">‚è≥</div>
            <div class="verify-info">
              <div class="verify-name">Handshake</div>
              <div class="verify-status">Waiting...</div>
            </div>
          </div>
          <div class="verify-item" id="verify-tools">
            <div class="verify-icon">‚è≥</div>
            <div class="verify-info">
              <div class="verify-name">Tools Listed</div>
              <div class="verify-status">Waiting...</div>
            </div>
          </div>
          <div class="verify-item" id="verify-call">
            <div class="verify-icon">‚è≥</div>
            <div class="verify-info">
              <div class="verify-name">Test Call</div>
              <div class="verify-status">Waiting...</div>
            </div>
          </div>
        </div>

        <div class="collapsible" onclick="toggleCollapsible('agent-verify')">
          <h3>‚ñ∏ Optional: Verify in Your AI Agent</h3>
        </div>
        <div class="collapsible-content" id="agent-verify">
          <p>Once you've confirmed the server is healthy above, optionally verify it appears in your AI agent:</p>
          <ul style="margin-left: 1.5rem; color: var(--gray-600);">
            <li>Open your AI agent's MCP/Tools settings</li>
            <li>Look for <strong>GRES B2B Governance</strong> or <strong>gres-b2b</strong></li>
            <li>If not visible, close and reopen your AI agent to reload config</li>
          </ul>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="prevStep()">Back</button>
          <button class="btn btn-primary" onclick="nextStep()">Continue to Project Setup</button>
        </div>
      </div>

      <!-- Step 4: Repo Onboarding -->
      <div class="step" data-step="4">
        <h2>Step 4: Project Setup</h2>
        <p>Choose where to run the governance scan.</p>

        <div class="tabs">
          <div class="tab active" onclick="switchProjectTab('github')">GitHub URL</div>
          <div class="tab" onclick="switchProjectTab('local')">Local Folder</div>
        </div>

        <div class="tab-content active" id="tab-github">
          <div class="input-group">
            <label>GitHub Repository URL</label>
            <input type="text" id="github-url" placeholder="https://github.com/owner/repo" oninput="updateProjectSetup()">
            <div class="hint">We'll clone this to a managed workspace for safe scanning</div>
          </div>
        </div>

        <div class="tab-content" id="tab-local">
          <div class="input-group">
            <label>Local Project Path</label>
            <input type="text" id="local-path" placeholder="C:\Projects\my-app or /home/user/my-app" oninput="updateProjectSetup()">
            <div class="hint">We'll copy to a workspace, or scan in-place with separate output</div>
          </div>
          <div class="mode-cards" style="grid-template-columns: 1fr 1fr;">
            <div class="mode-card selected" data-scanmode="copy" onclick="selectScanMode('copy')">
              <div class="icon">üìã</div>
              <div class="name">Copy to Workspace</div>
              <div class="desc">Safe: original unchanged</div>
              <div class="recommended">Recommended</div>
            </div>
            <div class="mode-card" data-scanmode="inplace" onclick="selectScanMode('inplace')">
              <div class="icon">üìÇ</div>
              <div class="name">Scan In-Place</div>
              <div class="desc">Output to separate .b2b dir</div>
            </div>
          </div>
        </div>

        <div id="project-commands" style="display:none;">
          <div class="terminal">
            <div class="terminal-header">
              <span class="terminal-dot red"></span>
              <span class="terminal-dot yellow"></span>
              <span class="terminal-dot green"></span>
              <span class="terminal-title" id="project-terminal-title">Setup Commands</span>
            </div>
            <div class="terminal-body" id="project-terminal-body"></div>
            <div class="terminal-actions">
              <button class="terminal-btn primary" onclick="copyProjectCommands()">Copy Commands</button>
            </div>
          </div>

          <div class="status-box info" id="workspace-info">
            <div class="status-icon">üìÅ</div>
            <div class="status-content">
              <strong id="workspace-title">Workspace</strong>
              <p id="workspace-desc">Details will appear here...</p>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="prevStep()">Back</button>
          <button class="btn btn-primary" onclick="nextStep()" id="step4-next" disabled>Continue to Scan</button>
        </div>
      </div>

      <!-- Step 5: Run Scan -->
      <div class="step" data-step="5">
        <h2>Step 5: Run Governance Scan</h2>
        <p>First ensure the CLI is installed, then run the scan command below.</p>

        <!-- Prerequisite: Install CLI -->
        <div class="status-box info" style="margin-bottom: 1.5rem;">
          <div class="status-icon">üì¶</div>
          <div class="status-content">
            <strong>Prerequisite: Install CLI</strong>
            <p style="margin-bottom: 0.5rem;">If you haven't installed <code>gres-b2b</code> yet, run one of these commands:</p>
          </div>
        </div>

        <div class="tabs" id="install-tabs">
          <div class="tab active" onclick="switchInstallTab('windows')">Windows</div>
          <div class="tab" onclick="switchInstallTab('macos')">macOS</div>
          <div class="tab" onclick="switchInstallTab('linux')">Linux</div>
        </div>

        <div class="tab-content active" id="install-windows">
          <div class="terminal">
            <div class="terminal-header">
              <span class="terminal-dot red"></span>
              <span class="terminal-dot yellow"></span>
              <span class="terminal-dot green"></span>
              <span class="terminal-title">PowerShell (Run as User)</span>
            </div>
            <div class="terminal-body">
              <div class="terminal-line comment"># One-line installer (no admin required)</div>
              <div class="terminal-line command" id="install-cmd-windows">irm https://ajranjith.github.io/b2b-governance-action/install.ps1 | iex</div>
            </div>
            <div class="terminal-actions">
              <button class="terminal-btn primary" onclick="copyCommand(document.getElementById('install-cmd-windows').textContent)">üìã Copy</button>
            </div>
          </div>
        </div>

        <div class="tab-content" id="install-macos">
          <div class="terminal">
            <div class="terminal-header">
              <span class="terminal-dot red"></span>
              <span class="terminal-dot yellow"></span>
              <span class="terminal-dot green"></span>
              <span class="terminal-title">Terminal</span>
            </div>
            <div class="terminal-body">
              <div class="terminal-line comment"># One-line installer</div>
              <div class="terminal-line command" id="install-cmd-macos">curl -fsSL https://ajranjith.github.io/b2b-governance-action/install.sh | bash</div>
            </div>
            <div class="terminal-actions">
              <button class="terminal-btn primary" onclick="copyCommand(document.getElementById('install-cmd-macos').textContent)">üìã Copy</button>
            </div>
          </div>
        </div>

        <div class="tab-content" id="install-linux">
          <div class="terminal">
            <div class="terminal-header">
              <span class="terminal-dot red"></span>
              <span class="terminal-dot yellow"></span>
              <span class="terminal-dot green"></span>
              <span class="terminal-title">Terminal</span>
            </div>
            <div class="terminal-body">
              <div class="terminal-line comment"># One-line installer</div>
              <div class="terminal-line command" id="install-cmd-linux">curl -fsSL https://ajranjith.github.io/b2b-governance-action/install.sh | bash</div>
            </div>
            <div class="terminal-actions">
              <button class="terminal-btn primary" onclick="copyCommand(document.getElementById('install-cmd-linux').textContent)">üìã Copy</button>
            </div>
          </div>
        </div>

        <div class="collapsible" onclick="toggleCollapsible('verify-install')" style="margin-top: 1rem;">
          <h3>‚ñ∏ Verify Installation</h3>
        </div>
        <div class="collapsible-content" id="verify-install">
          <div class="terminal">
            <div class="terminal-header">
              <span class="terminal-dot red"></span>
              <span class="terminal-dot yellow"></span>
              <span class="terminal-dot green"></span>
              <span class="terminal-title">Verify</span>
            </div>
            <div class="terminal-body">
              <div class="terminal-line comment"># Check version</div>
              <div class="terminal-line command">gres-b2b --version</div>
              <div class="terminal-line comment"># Check prerequisites</div>
              <div class="terminal-line command">gres-b2b doctor</div>
            </div>
            <div class="terminal-actions">
              <button class="terminal-btn primary" onclick="copyCommand('gres-b2b --version')">üìã Copy Version Check</button>
              <button class="terminal-btn secondary" onclick="copyCommand('gres-b2b doctor')">üìã Copy Doctor</button>
            </div>
          </div>
          <div class="status-box success" style="margin-top: 1rem;">
            <div class="status-icon">‚úÖ</div>
            <div class="status-content">
              <strong>Expected Output</strong>
              <p><code>gres-b2b version 1.x.x</code> (or similar)</p>
            </div>
          </div>
        </div>

        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--gray-200);">

        <h3>Run Scan</h3>
        <p>Copy the command below, paste it into your terminal, and run it.</p>

        <div class="status-box warning">
          <div class="status-icon">‚ö†Ô∏è</div>
          <div class="status-content">
            <strong>Important</strong>
            <p>This wizard is a static webpage ‚Äî it cannot run scans directly. The scan runs via the <code>gres-b2b</code> CLI you execute in your terminal.</p>
          </div>
        </div>

        <div class="terminal">
          <div class="terminal-header">
            <span class="terminal-dot red"></span>
            <span class="terminal-dot yellow"></span>
            <span class="terminal-dot green"></span>
            <span class="terminal-title" id="scan-terminal-title">PowerShell / Terminal</span>
          </div>
          <div class="terminal-body">
            <div class="terminal-line comment"># Copy and run in your terminal</div>
            <div class="terminal-line command" id="scan-command">gres-b2b scan</div>
          </div>
          <div class="terminal-actions">
            <button class="terminal-btn primary" onclick="copyScanCommand()">üìã Copy Scan Command</button>
          </div>
        </div>

        <div class="status-box success">
          <div class="status-icon">‚úÖ</div>
          <div class="status-content">
            <strong>What Happens Next</strong>
            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
              <li>The CLI starts a local web server on <code>127.0.0.1</code></li>
              <li>The CLI opens a browser tab with live progress</li>
              <li>When complete, you can open the full HTML report</li>
            </ul>
          </div>
        </div>

        <h3 style="margin-top: 1.5rem;">Expected Terminal Output</h3>
        <div class="terminal" style="margin-top: 0.5rem;">
          <div class="terminal-header">
            <span class="terminal-dot red"></span>
            <span class="terminal-dot yellow"></span>
            <span class="terminal-dot green"></span>
            <span class="terminal-title">What You'll See</span>
          </div>
          <div class="terminal-body">
            <div class="terminal-line success">Live progress: http://127.0.0.1:49321/progress?run=abc123</div>
            <div class="terminal-line output">Scanning workspace...</div>
            <div class="terminal-line output">Found 47 files to analyze</div>
            <div class="terminal-line success">Writing report: .b2b/report.html</div>
          </div>
        </div>

        <div class="status-box info">
          <div class="status-icon">üí°</div>
          <div class="status-content">
            <strong>If Nothing Opens</strong>
            <p>Copy the "Live progress" URL printed in your terminal and paste it into your browser.</p>
          </div>
        </div>

        <div class="status-box info">
          <div class="status-icon">üìä</div>
          <div class="status-content">
            <strong>Output Files</strong>
            <p>
              <code>.b2b/report.html</code> - Visual dashboard<br>
              <code>.b2b/report.json</code> - Machine-readable results<br>
              <code>.b2b/report.sarif.json</code> - GitHub Security format<br>
              <code>.b2b/report.junit.xml</code> - CI/CD test format
            </p>
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="prevStep()">Back</button>
          <button class="btn btn-primary" onclick="nextStep()">I Ran the Scan ‚Üí Continue</button>
        </div>
      </div>

      <!-- Step 6: Remediation Loop -->
      <div class="step" data-step="6">
        <h2>Step 6: Auto-Fix Loop (Optional)</h2>
        <p>Copy this command to automatically fix issues until all checks pass.</p>

        <div class="input-group">
          <label>Maximum Iterations</label>
          <select id="max-iterations" onchange="updateAutofixCommand()">
            <option value="3">3 iterations</option>
            <option value="5">5 iterations</option>
            <option value="10" selected>10 iterations</option>
            <option value="20">20 iterations</option>
          </select>
          <div class="hint">Stops when all GREEN or max reached</div>
        </div>

        <div class="terminal">
          <div class="terminal-header">
            <span class="terminal-dot red"></span>
            <span class="terminal-dot yellow"></span>
            <span class="terminal-dot green"></span>
            <span class="terminal-title">PowerShell / Terminal</span>
          </div>
          <div class="terminal-body">
            <div class="terminal-line comment"># Copy and run in your terminal</div>
            <div class="terminal-line command" id="autofix-command">gres-b2b fix --live --max-iterations=10</div>
          </div>
          <div class="terminal-actions">
            <button class="terminal-btn primary" onclick="copyAutofixCommand()">üìã Copy Auto-Fix Command</button>
          </div>
        </div>

        <div class="status-box success">
          <div class="status-icon">‚úÖ</div>
          <div class="status-content">
            <strong>What Happens</strong>
            <p>
              1. Browser opens with live progress (same as scan)<br>
              2. Each iteration: scan ‚Üí fix issues ‚Üí re-scan<br>
              3. Stops when all GREEN or max iterations reached
            </p>
          </div>
        </div>

        <h3>How It Works</h3>
        <div class="iteration-timeline" id="iteration-demo">
          <div class="iteration-item pass">
            <div class="iteration-header">
              <span class="iteration-title">Iteration 1</span>
              <div class="iteration-counts">
                <span class="count-red">5 RED</span>
                <span class="count-amber">8 AMBER</span>
                <span class="count-green">12 GREEN</span>
              </div>
            </div>
            <div style="font-size: 0.85rem; color: var(--gray-600);">Initial scan complete. Fixing 5 critical issues...</div>
          </div>
          <div class="iteration-item pass">
            <div class="iteration-header">
              <span class="iteration-title">Iteration 2</span>
              <div class="iteration-counts">
                <span class="count-red">1 RED</span>
                <span class="count-amber">4 AMBER</span>
                <span class="count-green">20 GREEN</span>
              </div>
            </div>
            <div style="font-size: 0.85rem; color: var(--gray-600);">Fixed 4 RED issues. Continuing...</div>
          </div>
          <div class="iteration-item pass">
            <div class="iteration-header">
              <span class="iteration-title">Iteration 3</span>
              <div class="iteration-counts">
                <span class="count-red">0 RED</span>
                <span class="count-amber">0 AMBER</span>
                <span class="count-green">25 GREEN</span>
              </div>
            </div>
            <div style="font-size: 0.85rem; color: var(--gray-600);">All GREEN! Stopping loop.</div>
          </div>
        </div>

        <div class="status-box success">
          <div class="status-icon">‚úÖ</div>
          <div class="status-content">
            <strong>Stop Conditions</strong>
            <p>
              ‚úì All checks are GREEN (success!)<br>
              ‚úì Max iterations reached<br>
              ‚úì No improvement after 3 consecutive attempts on same issue
            </p>
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="prevStep()">Back</button>
          <button class="btn btn-success btn-lg" onclick="nextStep()">Complete Setup</button>
        </div>
      </div>

      <!-- Step 7: Complete -->
      <div class="step" data-step="7">
        <div style="text-align: center; padding: 2rem 0;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
          <h2>Setup Complete!</h2>
          <p>Your governance workflow is ready.</p>
        </div>

        <h3>Verification Summary</h3>
        <div class="verification-grid">
          <div class="verify-item pass">
            <div class="verify-icon">‚úÖ</div>
            <div class="verify-info">
              <div class="verify-name">MCP Server</div>
              <div class="verify-status">Healthy (selftest passed)</div>
            </div>
          </div>
          <div class="verify-item pass" id="final-agent-status">
            <div class="verify-icon">‚úÖ</div>
            <div class="verify-info">
              <div class="verify-name">Agent Config</div>
              <div class="verify-status" id="final-agent-desc">Configured</div>
            </div>
          </div>
          <div class="verify-item pass">
            <div class="verify-icon">‚úÖ</div>
            <div class="verify-info">
              <div class="verify-name">Workspace</div>
              <div class="verify-status">Ready to scan</div>
            </div>
          </div>
        </div>

        <h3>Quick Commands</h3>
        <div class="terminal">
          <div class="terminal-header">
            <span class="terminal-dot red"></span>
            <span class="terminal-dot yellow"></span>
            <span class="terminal-dot green"></span>
            <span class="terminal-title">Reference</span>
          </div>
          <div class="terminal-body">
            <div class="terminal-line comment"># Check prerequisites and paths</div>
            <div class="terminal-line command">gres-b2b doctor</div>
            <div class="terminal-line comment"># Verify MCP server health</div>
            <div class="terminal-line command">gres-b2b mcp selftest</div>
            <div class="terminal-line comment"># Run scan with live browser progress</div>
            <div class="terminal-line command">gres-b2b scan</div>
            <div class="terminal-line comment"># Run scan (CLI output only)</div>
            <div class="terminal-line command">gres-b2b scan</div>
            <div class="terminal-line comment"># Auto-fix loop with live progress</div>
            <div class="terminal-line command">gres-b2b fix --live --max-iterations=10</div>
          </div>
        </div>

        <div class="status-box info">
          <div class="status-icon">üí¨</div>
          <div class="status-content">
            <strong>Ask Your AI Agent</strong>
            <p>
              "Run a governance scan"<br>
              "Fix all RED issues and re-scan"<br>
              "Show me the governance report"
            </p>
          </div>
        </div>

        <div class="status-box warning">
          <div class="status-icon">üîß</div>
          <div class="status-content">
            <strong>Troubleshooting</strong>
            <p>If you run into any issues (missing dependencies, permission errors, path problems), run:</p>
            <code style="display: block; margin-top: 0.5rem; padding: 0.5rem; background: var(--gray-100); border-radius: 4px;">gres-b2b doctor</code>
            <p style="margin-top: 0.5rem; margin-bottom: 0;">This prints actionable diagnostics for common problems.</p>
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="restartWizard()">Start Over</button>
          <a href="https://github.com/ajranjith/b2b-governance-action" target="_blank" class="btn btn-primary">View on GitHub</a>
        </div>
      </div>
    </div>
  </div>

  <div class="copy-feedback" id="copy-feedback">Copied to clipboard!</div>

  <script>
    // State
    let currentStep = 1;
    let selectedMode = null;
    let projectTab = 'github';
    let scanMode = 'copy';
    let detectedConfig = null;
    let workspacePath = null; // Stores the source path/URL from Step 4

    const flow = [1, 2, 3, 4, 5, 6, 7];
    const stepLabels = ['Mode', 'Config', 'Verify', 'Project', 'Scan', 'Fix', 'Done'];

    // Known agent config patterns
    const configAdapters = {
      codex: {
        name: 'Codex CLI',
        format: 'toml',
        patterns: ['.codex/config.toml', 'codex/config.toml'],
        defaultPaths: {
          windows: '%USERPROFILE%\\.codex\\config.toml',
          mac: '~/.codex/config.toml',
          linux: '~/.codex/config.toml'
        },
        generateEntry: (binaryPath) => `
[mcp_servers.gresB2BGovernance]
command = "${binaryPath}"
args = []
enabled = true
startup_timeout_sec = 20
tool_timeout_sec = 60`
      },
      claude: {
        name: 'Claude Desktop',
        format: 'json',
        patterns: ['claude_desktop_config.json', 'Claude/claude_desktop_config.json'],
        defaultPaths: {
          windows: '%APPDATA%\\Claude\\claude_desktop_config.json',
          mac: '~/Library/Application Support/Claude/claude_desktop_config.json',
          linux: '~/.config/Claude/claude_desktop_config.json'
        },
        generateEntry: (binaryPath) => `"mcpServers": {
  "gres-b2b": {
    "command": "${binaryPath}",
    "args": []
  }
}`
      },
      cursor: {
        name: 'Cursor',
        format: 'json',
        patterns: ['.cursor/mcp.json', 'cursor/mcp.json'],
        defaultPaths: {
          windows: '%USERPROFILE%\\.cursor\\mcp.json',
          mac: '~/.cursor/mcp.json',
          linux: '~/.cursor/mcp.json'
        },
        generateEntry: (binaryPath) => `{
  "mcpServers": {
    "gres-b2b": {
      "command": "${binaryPath}",
      "args": []
    }
  }
}`
      },
      windsurf: {
        name: 'Windsurf',
        format: 'json',
        patterns: ['.windsurf/mcp.json', 'windsurf/mcp.json'],
        defaultPaths: {
          windows: '%USERPROFILE%\\.windsurf\\mcp.json',
          mac: '~/.windsurf/mcp.json',
          linux: '~/.windsurf/mcp.json'
        },
        generateEntry: (binaryPath) => `{
  "mcpServers": {
    "gres-b2b": {
      "command": "${binaryPath}",
      "args": []
    }
  }
}`
      }
    };

    // Detect OS
    function detectOS() {
      const ua = navigator.userAgent.toLowerCase();
      if (ua.includes('win')) return 'windows';
      if (ua.includes('mac')) return 'mac';
      return 'linux';
    }

    const currentOS = detectOS();

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      updateStepIndicator();
    });

    function updateStepIndicator() {
      const indicator = document.getElementById('step-indicator');
      indicator.innerHTML = flow.map((step, i) => {
        const isActive = step === currentStep;
        const isCompleted = flow.indexOf(currentStep) > i;
        const className = isActive ? 'active' : (isCompleted ? 'completed' : '');
        return `<div class="step-dot ${className}" title="${stepLabels[i]}">${i + 1}</div>`;
      }).join('');
    }

    function selectMode(mode) {
      selectedMode = mode;
      document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
      document.querySelector(`.mode-card[data-mode="${mode}"]`).classList.add('selected');
      document.getElementById('step1-next').disabled = false;
    }

    function nextStep() {
      // Pre-step actions
      if (currentStep === 1) {
        generateConfigStep();
      }

      const currentIndex = flow.indexOf(currentStep);
      if (currentIndex < flow.length - 1) {
        currentStep = flow[currentIndex + 1];
        showStep(currentStep);

        // Update scan command when entering Step 5
        if (currentStep === 5) {
          updateScanCommand();
        }
      }
    }

    function prevStep() {
      const currentIndex = flow.indexOf(currentStep);
      if (currentIndex > 0) {
        currentStep = flow[currentIndex - 1];
        showStep(currentStep);
      }
    }

    function showStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
      updateStepIndicator();
      window.scrollTo(0, 0);
    }

    function generateConfigStep() {
      const content = document.getElementById('config-step-content');

      if (selectedMode === 'skip') {
        content.innerHTML = `
          <div class="status-box info">
            <div class="status-icon">‚è≠Ô∏è</div>
            <div class="status-content">
              <strong>Skipping Agent Configuration</strong>
              <p>You can configure your AI agent later. We'll still verify the MCP server works.</p>
            </div>
          </div>
          <p>When you're ready to configure your agent, add this MCP server entry:</p>
          <div class="config-preview">
            <span class="section">[mcp_servers.gresB2BGovernance]</span>
command = <span class="string">"gres-b2b"</span>
args = []
enabled = <span class="string">true</span>
          </div>
          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            <button class="btn btn-primary" onclick="nextStep()">Continue to Verification</button>
          </div>
        `;
        return;
      }

      if (selectedMode === 'auto') {
        content.innerHTML = `
          <div class="status-box info">
            <div class="status-icon">üîç</div>
            <div class="status-content">
              <strong>Auto-Detecting AI Agents</strong>
              <p>Scanning for known configuration files...</p>
            </div>
          </div>

          <div class="input-group">
            <label>Operating System</label>
            <select id="os-select" onchange="updateAutoDetect()">
              <option value="windows" ${currentOS === 'windows' ? 'selected' : ''}>Windows</option>
              <option value="mac" ${currentOS === 'mac' ? 'selected' : ''}>macOS</option>
              <option value="linux" ${currentOS === 'linux' ? 'selected' : ''}>Linux</option>
            </select>
          </div>

          <h3>Detected Agents</h3>
          <div id="detected-agents" class="mode-cards"></div>

          <div id="config-details" style="display:none;">
            <h3>Configuration</h3>
            <div class="input-group">
              <label>gres-b2b Binary Path</label>
              <input type="text" id="binary-path" value="gres-b2b" oninput="updateConfigPreview()">
              <div class="hint">Path to the gres-b2b executable</div>
            </div>

            <h4>Config Entry to Add</h4>
            <div class="config-preview" id="config-preview-auto"></div>

            <h4>Setup Script</h4>
            <div class="terminal">
              <div class="terminal-header">
                <span class="terminal-dot red"></span>
                <span class="terminal-dot yellow"></span>
                <span class="terminal-dot green"></span>
                <span class="terminal-title" id="script-title">Setup Script</span>
              </div>
              <div class="terminal-body" id="setup-script"></div>
              <div class="terminal-actions">
                <button class="terminal-btn primary" onclick="copySetupScript()">Copy Script</button>
              </div>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            <button class="btn btn-primary" onclick="nextStep()" id="step2-next">Continue to Verification</button>
          </div>
        `;
        setTimeout(updateAutoDetect, 100);
        return;
      }

      // Manual mode
      content.innerHTML = `
        <p>Paste your AI agent's config file path or folder path.</p>

        <div class="input-group">
          <label>Config Path</label>
          <input type="text" id="config-path" placeholder="C:\\Users\\...\\config.toml or ~/.cursor/mcp.json" oninput="detectConfigFormat()">
          <div class="hint">We'll detect the format (TOML/JSON/YAML) automatically</div>
        </div>

        <div id="detected-format" style="display:none;">
          <div class="status-box success">
            <div class="status-icon">‚úÖ</div>
            <div class="status-content">
              <strong id="detected-format-name">Format Detected</strong>
              <p id="detected-format-desc">Details here...</p>
            </div>
          </div>
        </div>

        <div class="input-group">
          <label>gres-b2b Binary Path</label>
          <input type="text" id="binary-path-manual" value="gres-b2b" oninput="updateManualPreview()">
        </div>

        <h4>Config Entry to Add</h4>
        <div class="config-preview" id="config-preview-manual">
          <span class="comment"># Enter a config path above to see the entry to add</span>
        </div>

        <div class="status-box warning" id="manual-fallback" style="display:none;">
          <div class="status-icon">‚ö†Ô∏è</div>
          <div class="status-content">
            <strong>Could Not Detect Format</strong>
            <p>Copy the snippet above and manually add it to your agent's config file.</p>
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-secondary" onclick="prevStep()">Back</button>
          <button class="btn btn-primary" onclick="nextStep()">Continue to Verification</button>
        </div>
      `;
    }

    function updateAutoDetect() {
      const os = document.getElementById('os-select').value;
      const container = document.getElementById('detected-agents');

      // Simulate detection
      container.innerHTML = Object.entries(configAdapters).map(([key, adapter]) => {
        const path = adapter.defaultPaths[os];
        return `
          <div class="mode-card" data-agent="${key}" onclick="selectAgent('${key}')">
            <div class="icon">${key === 'codex' ? 'üîÆ' : key === 'claude' ? 'ü§ñ' : key === 'cursor' ? '‚ö°' : 'üèÑ'}</div>
            <div class="name">${adapter.name}</div>
            <div class="desc" style="font-size:0.75rem; word-break:break-all;">${path}</div>
          </div>
        `;
      }).join('');

      // Auto-select first
      selectAgent('codex');
    }

    function selectAgent(agent) {
      detectedConfig = configAdapters[agent];
      document.querySelectorAll('#detected-agents .mode-card').forEach(c => c.classList.remove('selected'));
      document.querySelector(`#detected-agents .mode-card[data-agent="${agent}"]`).classList.add('selected');
      document.getElementById('config-details').style.display = 'block';
      updateConfigPreview();
    }

    function updateConfigPreview() {
      if (!detectedConfig) return;

      const binaryPath = document.getElementById('binary-path').value || 'gres-b2b';
      const os = document.getElementById('os-select').value;
      const configPath = detectedConfig.defaultPaths[os];

      // Preview
      const entry = detectedConfig.generateEntry(binaryPath.replace(/\\/g, '\\\\'));
      document.getElementById('config-preview-auto').innerHTML = `<pre style="margin:0; white-space:pre-wrap;">${escapeHtml(entry.trim())}</pre>`;

      // Script
      const script = generateSetupScript(detectedConfig, binaryPath, configPath, os);
      document.getElementById('setup-script').innerHTML = script;
      document.getElementById('script-title').textContent = os === 'windows' ? 'PowerShell' : 'Bash';
    }

    function generateSetupScript(adapter, binaryPath, configPath, os) {
      if (adapter.format === 'toml') {
        if (os === 'windows') {
          const expandedPath = configPath.replace(/%USERPROFILE%/g, '$env:USERPROFILE');
          return `<div class="terminal-line comment"># PowerShell: Add MCP server to ${adapter.name}</div>
<div class="terminal-line command">$configPath = "${expandedPath}"</div>
<div class="terminal-line command">$configDir = Split-Path $configPath -Parent</div>
<div class="terminal-line command">if (!(Test-Path $configDir)) { New-Item -ItemType Directory -Path $configDir -Force | Out-Null }</div>
<div class="terminal-line command">if (!(Test-Path $configPath)) { Set-Content $configPath "# ${adapter.name} configuration\`n" }</div>
<div class="terminal-line comment"># Append MCP server entry</div>
<div class="terminal-line command">$entry = @"

[mcp_servers.gresB2BGovernance]
command = "${binaryPath.replace(/\\/g, '\\\\')}"
args = []
enabled = true
startup_timeout_sec = 20
tool_timeout_sec = 60
"@</div>
<div class="terminal-line command">Add-Content $configPath $entry</div>
<div class="terminal-line command">Write-Host "Config updated: $configPath" -ForegroundColor Green</div>`;
        } else {
          const expandedPath = configPath.replace(/~/g, '$HOME');
          return `<div class="terminal-line comment"># Bash: Add MCP server to ${adapter.name}</div>
<div class="terminal-line command">CONFIG_PATH="${expandedPath}"</div>
<div class="terminal-line command">mkdir -p "$(dirname "$CONFIG_PATH")"</div>
<div class="terminal-line command">touch "$CONFIG_PATH"</div>
<div class="terminal-line comment"># Append MCP server entry</div>
<div class="terminal-line command">cat >> "$CONFIG_PATH" << 'EOF'

[mcp_servers.gresB2BGovernance]
command = "${binaryPath}"
args = []
enabled = true
startup_timeout_sec = 20
tool_timeout_sec = 60
EOF</div>
<div class="terminal-line command">echo "Config updated: $CONFIG_PATH"</div>`;
        }
      } else {
        return `<div class="terminal-line comment"># For JSON config, manually add this to:</div>
<div class="terminal-line comment"># ${configPath}</div>
<div class="terminal-line output"># Inside the JSON object, add:</div>
<div class="terminal-line command">"mcpServers": {
  "gres-b2b": {
    "command": "${binaryPath}",
    "args": []
  }
}</div>`;
      }
    }

    function detectConfigFormat() {
      const path = document.getElementById('config-path').value.toLowerCase();
      const formatDiv = document.getElementById('detected-format');
      const nameEl = document.getElementById('detected-format-name');
      const descEl = document.getElementById('detected-format-desc');

      let format = null;
      let agent = null;

      // Detect by filename
      if (path.endsWith('.toml')) {
        format = 'toml';
        if (path.includes('codex')) agent = 'codex';
      } else if (path.endsWith('.json')) {
        format = 'json';
        if (path.includes('claude')) agent = 'claude';
        if (path.includes('cursor')) agent = 'cursor';
        if (path.includes('windsurf')) agent = 'windsurf';
      } else if (path.endsWith('.yaml') || path.endsWith('.yml')) {
        format = 'yaml';
      }

      if (format) {
        formatDiv.style.display = 'block';
        nameEl.textContent = `Detected: ${format.toUpperCase()}` + (agent ? ` (${configAdapters[agent].name})` : '');
        descEl.textContent = agent ? `Will use ${configAdapters[agent].name} format` : `Will generate ${format.toUpperCase()} config entry`;
        document.getElementById('manual-fallback').style.display = 'none';
        updateManualPreview(format, agent);
      } else if (path.length > 5) {
        formatDiv.style.display = 'none';
        document.getElementById('manual-fallback').style.display = 'block';
        // Show generic TOML as fallback
        updateManualPreview('toml', null);
      } else {
        formatDiv.style.display = 'none';
        document.getElementById('manual-fallback').style.display = 'none';
      }
    }

    function updateManualPreview(format, agent) {
      const binaryPath = document.getElementById('binary-path-manual').value || 'gres-b2b';
      const preview = document.getElementById('config-preview-manual');

      format = format || 'toml';
      const adapter = agent ? configAdapters[agent] : configAdapters.codex;
      const entry = adapter.generateEntry(binaryPath);
      preview.innerHTML = `<pre style="margin:0; white-space:pre-wrap;">${escapeHtml(entry.trim())}</pre>`;
    }

    function runSelftestDemo() {
      const items = ['server', 'handshake', 'tools', 'call'];
      items.forEach((item, i) => {
        const el = document.getElementById(`verify-${item}`);
        const icon = el.querySelector('.verify-icon');
        const status = el.querySelector('.verify-status');

        // Start
        setTimeout(() => {
          el.classList.add('running');
          icon.textContent = '‚è≥';
          status.textContent = 'Testing...';
        }, i * 600);

        // Complete
        setTimeout(() => {
          el.classList.remove('running');
          el.classList.add('pass');
          icon.textContent = '‚úÖ';
          status.textContent = ['Server started on port 8765', 'MCP handshake OK', '5 tools available', 'doctor() returned OK'][i];
        }, (i + 1) * 600);
      });
    }

    function toggleCollapsible(id) {
      const content = document.getElementById(id);
      const header = content.previousElementSibling;
      content.classList.toggle('show');

      // Update header text based on which collapsible
      const h3 = header.querySelector('h3');
      const isOpen = content.classList.contains('show');
      if (id === 'agent-verify') {
        h3.textContent = isOpen ? '‚ñæ Optional: Verify in Your AI Agent' : '‚ñ∏ Optional: Verify in Your AI Agent';
      } else if (id === 'verify-install') {
        h3.textContent = isOpen ? '‚ñæ Verify Installation' : '‚ñ∏ Verify Installation';
      }
    }

    function switchInstallTab(os) {
      // Update tab active state
      document.querySelectorAll('#install-tabs .tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`#install-tabs .tab:nth-child(${os === 'windows' ? 1 : os === 'macos' ? 2 : 3})`).classList.add('active');

      // Update content visibility
      document.getElementById('install-windows').classList.toggle('active', os === 'windows');
      document.getElementById('install-macos').classList.toggle('active', os === 'macos');
      document.getElementById('install-linux').classList.toggle('active', os === 'linux');
    }

    function switchProjectTab(tab) {
      projectTab = tab;
      document.querySelectorAll('.step[data-step="4"] .tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.step[data-step="4"] .tab:${tab === 'github' ? 'first' : 'last'}-child`).classList.add('active');
      document.getElementById('tab-github').classList.toggle('active', tab === 'github');
      document.getElementById('tab-local').classList.toggle('active', tab === 'local');
      updateProjectSetup();
    }

    function selectScanMode(mode) {
      scanMode = mode;
      document.querySelectorAll('.step[data-step="4"] .mode-card[data-scanmode]').forEach(c => c.classList.remove('selected'));
      document.querySelector(`.mode-card[data-scanmode="${mode}"]`).classList.add('selected');
      updateProjectSetup();
    }

    function updateProjectSetup() {
      const githubUrl = document.getElementById('github-url').value;
      const localPath = document.getElementById('local-path').value;
      const commandsDiv = document.getElementById('project-commands');
      const terminalBody = document.getElementById('project-terminal-body');
      const nextBtn = document.getElementById('step4-next');

      let hasInput = false;
      let commands = '';
      let workspaceTitle = '';
      let workspaceDesc = '';

      if (projectTab === 'github' && githubUrl.startsWith('https://github.com/')) {
        hasInput = true;
        const repoName = githubUrl.split('/').pop().replace('.git', '');
        const ts = Date.now();
        const wsPath = `.b2b/workspaces/${repoName}-${ts}`;

        workspaceTitle = 'Cloned Repository';
        workspaceDesc = `Source: ${githubUrl}<br>Workspace: ${wsPath}`;

        if (currentOS === 'windows') {
          commands = `<div class="terminal-line comment"># Clone repo to managed workspace</div>
<div class="terminal-line command">git clone --depth 1 ${githubUrl} ${wsPath.replace(/\//g, '\\')}</div>
<div class="terminal-line command">cd ${wsPath.replace(/\//g, '\\')}</div>
<div class="terminal-line command">git checkout -b gres-b2b-fixes/${ts}</div>`;
        } else {
          commands = `<div class="terminal-line comment"># Clone repo to managed workspace</div>
<div class="terminal-line command">git clone --depth 1 ${githubUrl} ${wsPath}</div>
<div class="terminal-line command">cd ${wsPath}</div>
<div class="terminal-line command">git checkout -b gres-b2b-fixes/${ts}</div>`;
        }
      } else if (projectTab === 'local' && localPath.length > 3) {
        hasInput = true;
        const ts = Date.now();

        if (scanMode === 'copy') {
          const folderName = localPath.split(/[/\\]/).pop();
          const wsPath = `.b2b/workspaces/${folderName}-${ts}`;
          workspaceTitle = 'Copied to Workspace';
          workspaceDesc = `Source: ${localPath}<br>Workspace: ${wsPath}`;

          if (currentOS === 'windows') {
            commands = `<div class="terminal-line comment"># Copy project to managed workspace</div>
<div class="terminal-line command">xcopy "${localPath}" "${wsPath.replace(/\//g, '\\')}" /E /I /H</div>
<div class="terminal-line command">cd ${wsPath.replace(/\//g, '\\')}</div>
<div class="terminal-line command">git init</div>
<div class="terminal-line command">git checkout -b gres-b2b-fixes/${ts}</div>`;
          } else {
            commands = `<div class="terminal-line comment"># Copy project to managed workspace</div>
<div class="terminal-line command">cp -r "${localPath}" "${wsPath}"</div>
<div class="terminal-line command">cd ${wsPath}</div>
<div class="terminal-line command">git init</div>
<div class="terminal-line command">git checkout -b gres-b2b-fixes/${ts}</div>`;
          }
        } else {
          workspaceTitle = 'In-Place Scan';
          workspaceDesc = `Source: ${localPath}<br>Output: ${localPath}/.b2b/`;

          commands = `<div class="terminal-line comment"># Scan in-place (output to .b2b folder)</div>
<div class="terminal-line command">cd "${localPath}"</div>
<div class="terminal-line command">git checkout -b gres-b2b-fixes/${ts}</div>`;
        }
      }

      if (hasInput) {
        commandsDiv.style.display = 'block';
        terminalBody.innerHTML = commands;
        document.getElementById('workspace-title').textContent = workspaceTitle;
        document.getElementById('workspace-desc').innerHTML = workspaceDesc;
        nextBtn.disabled = false;

        // Store workspace path for scan command
        if (projectTab === 'github') {
          workspacePath = githubUrl;
        } else {
          workspacePath = localPath;
        }
      } else {
        commandsDiv.style.display = 'none';
        nextBtn.disabled = true;
        workspacePath = null;
      }
    }

    function updateScanCommand() {
      const scanCmd = document.getElementById('scan-command');
      const autofixCmd = document.getElementById('autofix-command');
      const maxIterations = document.getElementById('max-iterations')?.value || '10';

      if (workspacePath) {
        scanCmd.textContent = `gres-b2b scan`;
        if (autofixCmd) {
          autofixCmd.textContent = `gres-b2b fix --live --max-iterations=${maxIterations} --source "${workspacePath}"`;
        }
      } else {
        scanCmd.textContent = 'gres-b2b scan';
        if (autofixCmd) {
          autofixCmd.textContent = `gres-b2b fix --live --max-iterations=${maxIterations}`;
        }
      }
    }

    function updateAutofixCommand() {
      const max = document.getElementById('max-iterations').value;
      let cmd = `gres-b2b fix --live --max-iterations=${max}`;
      if (workspacePath) {
        cmd += ` --source "${workspacePath}"`;
      }
      document.getElementById('autofix-command').textContent = cmd;
    }

    function copyScanCommand() {
      copyToClipboard(document.getElementById('scan-command').textContent);
    }

    function copyCommand(cmd) {
      copyToClipboard(cmd);
    }

    function copySetupScript() {
      const commands = document.querySelectorAll('#setup-script .terminal-line.command');
      const text = Array.from(commands).map(c => c.textContent).join('\n');
      copyToClipboard(text);
    }

    function copyProjectCommands() {
      const commands = document.querySelectorAll('#project-terminal-body .terminal-line.command');
      const text = Array.from(commands).map(c => c.textContent).join('\n');
      copyToClipboard(text);
    }

    function copyAutofixCommand() {
      copyToClipboard(document.getElementById('autofix-command').textContent);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        const feedback = document.getElementById('copy-feedback');
        feedback.classList.add('show');
        setTimeout(() => feedback.classList.remove('show'), 2000);
      });
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function restartWizard() {
      currentStep = 1;
      selectedMode = null;
      document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
      document.getElementById('step1-next').disabled = true;
      showStep(1);
    }
  </script>
</body>
</html>

